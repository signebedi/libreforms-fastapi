{% extends "base.html.jinja" %}

{% block title %}
{{config.SITE_NAME}} â€” Edit Form Config
{% endblock %}

{% block header %}
{% endblock %}


{% block content %}
<h1>
    Edit Form Config
    <sup title="This is an admin page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
    </sup>
</h1>
<hr>

<form id="configForm">
    <fieldset class="form-check" style="padding-top: 10px;">
        <label aria-labelledby="configDescription" for="content" class="form-check-label">Form Config</label>
        <span id="configDescription" class="form-text">| Update the form config for the site using this page</span>
        {# <textarea class="form-control language-html" id="content" name="content" rows="10" style="resize: vertical; max-height: 50%;" required>{{ form_config_str }}</textarea> #}

        <!-- Monaco editor -->
        <div id="editor" style="height: 500px;"></div>  

    </fieldset>


    <fieldset class="form-check" style="padding-top: 10px;">
        <label aria-labelledby="configDescription" for="content" class="form-check-label">Past Versions</label>
        <span id="configDescription" class="form-text">| Select past versions of this form</span>

        <select id="versionSelector" class="form-select">
            <option value="{{ form_config_str }}">Current Version</option>

            {% for file, time_string, date, old_version_str, addition, subtraction in past_versions %}
            <option 
                value="{{ old_version_str }}"
                title="{{ date }} version has {{addition}} additions and {{subtraction}} subtractions versus the current version">
                {{ date }} ({{ addition }} additions, {{ subtraction }} subtractions)
            </option>
            {% endfor %}
        </select>


    </fieldset>


    <fieldset style="padding-top: 10px;" class="form-check">
        <button type="submit" class="btn btn-primary" id="updateButton">Update</button>
    </fieldset>
</form>

{# <div style="margin-top:15px;" class="accordion" id="accordionExample">
    <div class="accordion-item">
        <h4 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            Past Versions
            </button>
        </h4>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample" style="">
            <div class="accordion-body">

                <ul class="list-group form-check">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-link" value="{{ form_config_str | replace('\n', '\\n') | replace('\"', '\\\"') | safe }}">Current Version</button>
                    </li>

                    {% for file, time_string, date, old_version_str, addition, subtraction in past_versions %}
                    <li title="{{ date }} version has {{addition}} additions and {{subtraction}} subtractions versus the current version" class="list-group-item d-flex justify-content-between align-items-center">
                        
                        <button type="button" class="btn btn-link" value="{{ old_version_str | replace('\n', '\\n') | replace('\"', '\\\"') | safe }}">{{ date }}</button>

                        <div>
                            <span class="badge bg-success rounded-pill">{{ addition }}</span>
                            <span class="badge bg-danger rounded-pill">{{ subtraction }}</span>
                        </div>
                    </li>
                    {% endfor%}
                </ul>

            </div>
        </div>
    </div>
</div> #}




{% endblock %}


{% block scripts %}
<script src="{{ url_for('static', path='js/monaco-editor-0.48.0/min/vs/loader.js') }}"></script>

<script>
require.config({ paths: { 'vs': '{{ url_for("static", path="js/monaco-editor-0.48.0/min/vs") }}' }});

require(['vs/editor/editor.main'], function() {

    // Map site theme to the monaco theme
    function getMonacoTheme() {
        var siteTheme = localStorage.getItem('theme');
        return siteTheme === 'dark' ? 'vs-dark' : 'vs'; 
    }

    var editor = monaco.editor.create(document.getElementById('editor'), {
        value: "{{ form_config_str | replace('\n', '\\n') | replace('\"', '\\\"') | safe }}", 
        language: 'yaml',
        wordWrap: 'on',
        theme: getMonacoTheme()
    });

    // Listen for theme changes 
    document.addEventListener('themeChanged', function(event) {
        var newTheme = event.detail.theme === 'dark' ? 'vs-dark' : 'vs';
        monaco.editor.setTheme(newTheme);
    });

    // Add event listener to the select element
    document.getElementById('versionSelector').addEventListener('change', function(event) {
        var selectedValue = event.target.value.replace(/\\"/g, '"').replace(/\\n/g, '\n'); // Replace \\" with ", and \\n with actual newlines
        editor.setValue(selectedValue); // Set the selected version as the editor's value
    });

    $('#configForm').submit(function(event) {
        event.preventDefault();
        var formData = {
            "content": editor.getValue() // Get content from Monaco Editor
        };
        console.log(formData);
        var apiKey = "{{ request.user.api_key }}"; 

        $.ajax({
            url: `/api/admin/write_form_config`,
            type: 'POST',
            headers: {
                'X-API-KEY': apiKey,
            },
            data: JSON.stringify(formData),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(response) {
                flashMessage("Successfully updated form config", "success");
            },
            error: function(xhr) {
                console.error('Operation failed', xhr.responseText);
                flashMessage(xhr.responseText, 'warning');
            }
        });
    });
});
</script>
{% endblock %}
